<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Koleksi Produk</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="allproduk.css" />
  </head>

  <body>
    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg navbar-custom fixed-top">
      <div class="container">
        <a class="navbar-brand fw-bold" href="index.html">
          <img src="image/logo.png" alt="logo" />
        </a>

        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#mainNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="mainNav">
          <ul class="navbar-nav mx-auto gap-3">
            <li class="nav-item">
              <a class="nav-link" href="index.html">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="allProduk.html">Shop</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="index.html#about">About Us</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="index.html#contact">Contact</a>
            </li>

            <li class="nav-item">
              <a class="nav-link position-relative" href="cart.html">
                üõí Keranjang
                <span
                  id="cart-count"
                  class="badge bg-danger position-absolute top-0 start-100 translate-middle rounded-pill"
                  >0</span
                >
              </a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- PRODUK SECTION -->
    <section id="products" class="container p-4">
      <div
        class="d-flex justify-content-between align-items-center mb-4 reveal"
      >
        <h2 class="fw-bold title-brown">Koleksi Modern</h2>
        <button class="btn btn-brown-outline" onclick="history.go(-1)">
          ‚Üê Kembali
        </button>
      </div>

      <div class="mb-4 reveal">
        <input
          type="text"
          id="searchBar"
          class="form-control"
          placeholder="Cari produk terbaik..."
          onkeyup="searchProduk()"
        />
      </div>

      <div class="row g-4" id="produk-list"></div>

      <nav>
        <ul id="pagination" class="pagination justify-content-center mt-4"></ul>
      </nav>
    </section>

    <!-- SCRIPT -->
    <script>
      let allData = [];
      let filteredData = [];
      let currentPage = 1;
      const itemsPerPage = 12;

      /* =====================================================
       FETCH DATA
    =====================================================*/
      fetch("produk.json")
        .then((res) => res.json())
        .then((data) => {
          allData = data.sort((a, b) => Number(a.id) - Number(b.id));
          filteredData = allData;
          tampilkanProduk();
          setupLazyLoading();
          setupScrollReveal();
        });

      /* =====================================================
       RENDER PRODUK
    =====================================================*/
      function tampilkanProduk() {
        const container = document.getElementById("produk-list");
        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const paginatedItems = filteredData.slice(start, end);

        container.innerHTML = paginatedItems
          .map((item) => {
            const harga = item.harga.toLocaleString("id-ID");
            const kategori = item.tags?.length ? item.tags[0] : "fashion";
            const stockValue = item.stock || 10;

            return `
          <div class="col-lg-4 col-md-6 col-sm-6">
            <div class="product-card p-0 reveal">

              <div class="img-container position-relative">
                <span class="category-label position-absolute badge bg-dark"
                      style="top: 10px; right: 10px; text-transform: capitalize;">
                  ${kategori}
                </span>

                <img data-src="${item.gambar}" alt="${item.nama}"
                     class="img-fluid w-100 img-lazy">
              </div>

              <div class="p-3">
                <h6 class="fw-semibold mb-1">${item.nama}</h6>

                <p class="small text-muted mb-1">
                  <span class="rating-star me-1">‚òÖ</span>
                  4.${item.id} (1.${item.id}k Reviews)
                </p>

                <p class="fw-bold fs-5 mb-2 text-dark">Rp ${harga}</p>

                <p class="text-success fw-bold mb-2">
                  Stok: <span id="stock-${item.id}">${stockValue}</span>
                </p>

                <div class="d-flex align-items-center gap-2 mb-3 product-qty-controls">
                  <button class="btn btn-outline-dark btn-sm qty-btn"
                          onclick="minusQty('${item.id}')">‚àí</button>

                  <span id="qty-${item.id}" class="fw-bold qty-value">1</span>

                  <button class="btn btn-outline-dark btn-sm qty-btn"
                          onclick="plusQty('${
                            item.id
                          }', ${stockValue})">+</button>
                </div>

                <div class="d-flex gap-2">
                  <button class="btn btn-add-to-cart w-100 fw-semibold"
                          onclick="addToCart('${item.id}', ${stockValue})">
                    Add to Cart
                  </button>

                  <a class="btn btn-buy-now-brown w-100 fw-semibold"
                     href="https://wa.me/628xxxxxxx?text=Saya%20ingin%20beli%20${encodeURIComponent(
                       item.nama
                     )}"
                     target="_blank">Buy Now</a>
                </div>

                <button class="btn btn-outline-secondary w-100 mt-2 fw-semibold"
                        onclick="showDetail('${item.id}')">
                  Lihat Detail
                </button>
              </div>

            </div>
          </div>
        `;
          })
          .join("");

        buatPagination();
        setupLazyLoading();
        setupScrollReveal();
      }

      /* =====================================================
       QTY
    =====================================================*/
      function plusQty(id, stock) {
        let qty = Number(document.getElementById(`qty-${id}`).textContent);
        if (qty < stock) qty++;
        document.getElementById(`qty-${id}`).textContent = qty;
      }

      function minusQty(id) {
        let qty = Number(document.getElementById(`qty-${id}`).textContent);
        if (qty > 1) qty--;
        document.getElementById(`qty-${id}`).textContent = qty;
      }

      /* =====================================================
       CART
    =====================================================*/
      let cart = JSON.parse(localStorage.getItem("cart")) || [];

      function addToCart(id) {
        let qty = Number(document.getElementById(`qty-${id}`).textContent);
        let stockEl = document.getElementById(`stock-${id}`);
        let stock = Number(stockEl.textContent);

        if (qty > stock) {
          alert("Stok tidak cukup! Sisa: " + stock);
          return;
        }

        stock -= qty;
        stockEl.textContent = stock;

        for (let i = 0; i < qty; i++) cart.push({ id });

        localStorage.setItem("cart", JSON.stringify(cart));
        updateCartCount();
        alert(`Berhasil menambahkan ${qty} item ke keranjang!`);
      }

      function updateCartCount() {
        document.getElementById("cart-count").textContent = cart.length;
      }

      updateCartCount();

      function showDetail(id) {
        window.location.href = "detail.html?id=" + id;
      }

      /* =====================================================
       PAGINATION
    =====================================================*/
      function buatPagination() {
        const totalPages = Math.ceil(filteredData.length / itemsPerPage);
        const pagination = document.getElementById("pagination");

        pagination.innerHTML = `
        <li class="page-item ${currentPage === 1 ? "disabled" : ""}">
          <a class="page-link" href="#" onclick="gantiHalaman(${
            currentPage - 1
          })">Prev</a>
        </li>
      `;

        for (let i = 1; i <= totalPages; i++) {
          pagination.innerHTML += `
          <li class="page-item ${i === currentPage ? "active" : ""}">
            <a class="page-link" href="#" onclick="gantiHalaman(${i})">${i}</a>
          </li>
        `;
        }

        pagination.innerHTML += `
        <li class="page-item ${currentPage === totalPages ? "disabled" : ""}">
          <a class="page-link" href="#" onclick="gantiHalaman(${
            currentPage + 1
          })">Next</a>
        </li>
      `;
      }

      function gantiHalaman(hal) {
        if (hal < 1 || hal > Math.ceil(filteredData.length / itemsPerPage))
          return;
        currentPage = hal;

        document
          .getElementById("products")
          .scrollIntoView({ behavior: "smooth" });
        tampilkanProduk();
      }

      /* =====================================================
       SEARCH
    =====================================================*/
      function searchProduk() {
        let keyword = document.getElementById("searchBar").value.toLowerCase();

        filteredData = allData.filter(
          (item) =>
            item.nama.toLowerCase().includes(keyword) ||
            item.tags?.some((tag) => tag.toLowerCase().includes(keyword))
        );

        currentPage = 1;
        tampilkanProduk();
      }

      /* =====================================================
       SCROLL REVEAL
    =====================================================*/
      function setupScrollReveal() {
        const elements = document.querySelectorAll(".reveal");

        elements.forEach((el) => el.classList.remove("active"));

        const observer = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              if (entry.isIntersecting) {
                entry.target.classList.add("active");
                observer.unobserve(entry.target);
              }
            });
          },
          { threshold: 0.1 }
        );

        elements.forEach((el) => observer.observe(el));
      }

      /* =====================================================
       LAZY LOAD
    =====================================================*/
      function setupLazyLoading() {
        const images = document.querySelectorAll("img.img-lazy");

        const observer = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              if (entry.isIntersecting) {
                const img = entry.target;
                const src = img.getAttribute("data-src");

                if (src) {
                  img.src = src;
                  img.onload = () => img.classList.add("loaded");
                }
                observer.unobserve(img);
              }
            });
          },
          {
            rootMargin: "0px 0px 50px 0px",
            threshold: 0.01,
          }
        );

        images.forEach((img) => observer.observe(img));
      }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
